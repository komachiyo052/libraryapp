let lastIsbn = "";
let isScanning = false;

// ページ読み込み時に保存された設定を復元
window.onload = () => {
    document.getElementById('api-key').value = localStorage.getItem('calil_api_key') || '';
    document.getElementById('pref-id').value = localStorage.getItem('calil_system_id') || '';
};

// 設定を保存する関数
function saveSettings() {
    const apiKey = document.getElementById('api-key').value;
    const systemId = document.getElementById('pref-id').value;
    localStorage.setItem('calil_api_key', apiKey);
    localStorage.setItem('calil_system_id', systemId);
    alert("設定を保存しました！");
}

function startScanner() {
    saveSettings(); // スキャン開始時に自動保存
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["ean_reader"] }
    }, function(err) {
        if (err) { alert("カメラの起動に失敗しました: " + err); return; }
        Quagga.start();
        isScanning = true;
    });
}

Quagga.onDetected(function(data) {
    const code = data.codeResult.code;
    if (code.startsWith("978") && code.length === 13) {
        if (code !== lastIsbn) {
            lastIsbn = code;
            addBookToList(code);
            // 3秒間は同じバーコードを反応させない
            setTimeout(() => { lastIsbn = ""; }, 3000);
        }
    }
});

function addBookToList(isbn) {
    const tableBody = document.querySelector("#result-table tbody");
    const row = tableBody.insertRow(0);
    row.id = `row-${isbn}`;
    row.innerHTML = `
        <td>${isbn}</td>
        <td id="status-${isbn}">取得中...</td>
        <td id="link-${isbn}">-</td>
    `;
    fetchLibraryStatus(isbn);
}

// カーリルAPI呼び出し（JSONP + 自動リトライ対応）
function fetchLibraryStatus(isbn) {
    const apiKey = localStorage.getItem('calil_api_key');
    const systemId = localStorage.getItem('calil_system_id');
    
    if (!apiKey || !systemId) {
        document.getElementById(`status-${isbn}`).innerText = "設定不足";
        return;
    }

    const callbackName = `callback_${isbn}_${Date.now()}`; // 重複防止
    
    window[callbackName] = function(data) {
        if (data.continue === 1) {
            // 取得中の場合は2秒後に再試行
            document.getElementById(`status-${isbn}`).innerText = "検索中...";
            setTimeout(() => fetchLibraryStatus(isbn), 2000);
        } else {
            renderResult(isbn, data);
        }
        document.getElementById(`script-${isbn}`).remove();
        delete window[callbackName];
    };

    const url = `https://api.calil.jp/check?appkey=${apiKey}&isbn=${isbn}&systemid=${systemId}&format=json&callback=${callbackName}`;
    const script = document.createElement('script');
    script.id = `script-${isbn}`;
    script.src = url;
    document.body.appendChild(script);
}

function renderResult(isbn, data) {
    const systemId = localStorage.getItem('calil_system_id');
    const statusTd = document.getElementById(`status-${isbn}`);
    const linkTd = document.getElementById(`link-${isbn}`);
    
    const libData = data.libkey[systemId];
    
    if (!libData) {
        statusTd.innerText = "蔵書なし";
    } else {
        // カーリルの状態表記を分かりやすく変換
        const statusMap = { 'OK': '蔵書あり', 'T貸出中': '貸出中', '蔵書あり': '蔵書あり', '貸出中': '貸出中' };
        statusTd.innerText = statusMap[libData] || libData;
    }
    linkTd.innerHTML = `<a href="https://calil.jp/book/${isbn}" target="_blank">予約</a>`;
}

function copyToClipboard() {
    const rows = document.querySelectorAll("#result-table tbody tr");
    if (rows.length === 0) { alert("コピーするデータがありません"); return; }
    
    let text = "【図書館検索結果】\n";
    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        text += `ISBN:${cells[0].innerText} | 状態:${cells[1].innerText}\n`;
    });
    
    navigator.clipboard.writeText(text).then(() => alert("コピー完了！"));
}
