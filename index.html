<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›³æ›¸é¤¨è”µæ›¸ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f4f9; }
        #interactive { width: 100%; height: 250px; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .controls { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        input, button { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; cursor: pointer; border: none; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #eee; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <h2>ğŸ“š å›³æ›¸é¤¨è”µæ›¸ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ V.0.3</h2>

    <div class="controls">
        <input type="text" id="pref-id" placeholder="è‡ªæ²»ä½“å (ä¾‹: æ±äº¬éƒ½)" value="æ±äº¬éƒ½">
        <input type="text" id="api-key" placeholder="ã‚«ãƒ¼ãƒªãƒ«APIã‚­ãƒ¼ã‚’å…¥åŠ›">
    </div>

    <div id="interactive" class="viewport"></div>

    <div class="controls">
        <button onclick="startScanner()">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
        <button onclick="copyToClipboard()" style="background: #28a745;">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>

    <table id="result-table">
        <thead>
            <tr>
                <th>ISBN</th>
                <th>çŠ¶æ…‹</th>
                <th>ãƒªãƒ³ã‚¯</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

<script>
let lastIsbn = "";
let isScanning = false;

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒ
window.onload = () => {
    document.getElementById('api-key').value = localStorage.getItem('calil_api_key') || '';
    document.getElementById('pref-id').value = localStorage.getItem('calil_system_id') || '';
};

// è¨­å®šã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
function saveSettings() {
    const apiKey = document.getElementById('api-key').value;
    const systemId = document.getElementById('pref-id').value;
    localStorage.setItem('calil_api_key', apiKey);
    localStorage.setItem('calil_system_id', systemId);
    alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
}

function startScanner() {
    saveSettings(); // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹æ™‚ã«è‡ªå‹•ä¿å­˜
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["ean_reader"] }
    }, function(err) {
        if (err) { alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err); return; }
        Quagga.start();
        isScanning = true;
    });
}

Quagga.onDetected(function(data) {
    const code = data.codeResult.code;
    if (code.startsWith("978") && code.length === 13) {
        if (code !== lastIsbn) {
            lastIsbn = code;
            addBookToList(code);
            // 3ç§’é–“ã¯åŒã˜ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’åå¿œã•ã›ãªã„
            setTimeout(() => { lastIsbn = ""; }, 3000);
        }
    }
});

function addBookToList(isbn) {
    const tableBody = document.querySelector("#result-table tbody");
    const row = tableBody.insertRow(0);
    row.id = `row-${isbn}`;
    row.innerHTML = `
        <td>${isbn}</td>
        <td id="status-${isbn}">å–å¾—ä¸­...</td>
        <td id="link-${isbn}">-</td>
    `;
    fetchLibraryStatus(isbn);
}

// ã‚«ãƒ¼ãƒªãƒ«APIå‘¼ã³å‡ºã—ï¼ˆJSONP + è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤å¯¾å¿œï¼‰
// ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹å¤‰æ•°ã‚’è¿½åŠ ï¼ˆé–¢æ•°ã®å¤–ã«ç½®ãï¼‰
let retryCounts = {};

function fetchLibraryStatus(isbn) {
    const apiKey = localStorage.getItem('calil_api_key');
    const systemId = localStorage.getItem('calil_system_id');
    
    // ãƒªãƒˆãƒ©ã‚¤å›æ•°ã®åˆæœŸåŒ–
    if (!retryCounts[isbn]) retryCounts[isbn] = 0;
    retryCounts[isbn]++;

    const callbackName = `callback_${isbn}_${Date.now()}`;
    
    window[callbackName] = function(data) {
        if (data.continue === 1) {
            // ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’è¡¨ç¤ºã«å‡ºã™ã“ã¨ã§ã€Œå‹•ã„ã¦ã„ã‚‹æ„Ÿã€ã‚’å‡ºã™
            document.getElementById(`status-${isbn}`).innerText = `æ¤œç´¢ä¸­...(${retryCounts[isbn]}å›ç›®)`;
            
            // æœ€å¤§15å›ï¼ˆç´„30ç§’ï¼‰ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã•ã›ã‚‹
            if (retryCounts[isbn] < 15) {
                setTimeout(() => fetchLibraryStatus(isbn), 2000);
            } else {
                document.getElementById(`status-${isbn}`).innerText = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆå›³æ›¸é¤¨HPãŒé‡ã„ã‚ˆã†ã§ã™ï¼‰";
            }
        } else {
            renderResult(isbn, data);
        }
        document.getElementById(`script-${isbn}`).remove();
        delete window[callbackName];
    };

    // ã€é‡è¦ã€‘URLã®æœ«å°¾ã« &t=ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— ã‚’è¿½åŠ ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å›é¿
    const url = `https://api.calil.jp/check?appkey=${apiKey}&isbn=${isbn}&systemid=${systemId}&format=json&callback=${callbackName}&t=${Date.now()}`;
    
    const script = document.createElement('script');
    script.id = `script-${isbn}`;
    script.src = url;
    document.body.appendChild(script);
}

function renderResult(isbn, data) {
    const systemId = localStorage.getItem('calil_system_id');
    const statusTd = document.getElementById(`status-${isbn}`);
    const linkTd = document.getElementById(`link-${isbn}`);
    
    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ˜ã‚Šä¸‹ã’: data.books[isbn][systemId]
    const bookData = data.books && data.books[isbn] ? data.books[isbn][systemId] : null;
    
    if (!bookData || !bookData.libkey) {
        statusTd.innerText = "è”µæ›¸ãªã—(ã¾ãŸã¯å–å¾—å¤±æ•—)";
        return;
    }

    // å„é¤¨ã®çŠ¶æ³ã‚’ã¾ã¨ã‚ã‚‹ï¼ˆä¾‹ï¼š1é¤¨ã§ã‚‚ã€Œè²¸å‡ºå¯ã€ãŒã‚ã‚Œã°ã€Œåœ¨åº«ã‚ã‚Šã€ã¨ã™ã‚‹ï¼‰
    const libs = bookData.libkey;
    const libNames = Object.keys(libs);
    
    if (libNames.length === 0) {
        statusTd.innerText = "è”µæ›¸ãªã—";
    } else {
        // å…¨é¤¨ã®çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        const statuses = Object.values(libs);
        if (statuses.includes("è²¸å‡ºå¯") || statuses.includes("åœ¨åº«ã‚ã‚Š") || statuses.includes("ã‚ã‚Š")) {
            statusTd.innerText = "åœ¨åº«ã‚ã‚Š";
        } else if (statuses.every(s => s.includes("è²¸å‡ºä¸­"))) {
            statusTd.innerText = "å…¨é¤¨è²¸å‡ºä¸­";
        } else {
            // ã©ã‚Œã«ã‚‚å½“ã¦ã¯ã¾ã‚‰ãªã„å ´åˆã¯æœ€åˆã®é¤¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºã—ã¦ã¿ã‚‹
            statusTd.innerText = statuses[0];
        }
    }

    // äºˆç´„URLã®è¡¨ç¤ºï¼ˆAPIã®çµæœã«å«ã¾ã‚Œã‚‹URLã‚’ä½¿ç”¨ï¼‰
    if (bookData.reserveurl) {
        linkTd.innerHTML = `<a href="${bookData.reserveurl}" target="_blank">äºˆç´„ã™ã‚‹</a>`;
    } else {
        linkTd.innerHTML = `<a href="https://calil.jp/book/${isbn}" target="_blank">è©³ç´°</a>`;
    }
}

function copyToClipboard() {
    const rows = document.querySelectorAll("#result-table tbody tr");
    if (rows.length === 0) { alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    
    let text = "ã€å›³æ›¸é¤¨æ¤œç´¢çµæœã€‘\n";
    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        text += `ISBN:${cells[0].innerText} | çŠ¶æ…‹:${cells[1].innerText}\n`;
    });
    
    navigator.clipboard.writeText(text).then(() => alert("ã‚³ãƒ”ãƒ¼å®Œäº†ï¼"));
}
</script>
</body>
</html>
