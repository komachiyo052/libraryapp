<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›³æ›¸é¤¨è”µæ›¸ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 15px; background: #f0f2f5; color: #333; }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 15px; }
        
        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .section { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .pw-container { position: relative; flex-grow: 1; display: flex; }
        input { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
        button { padding: 10px 16px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        
        .btn-primary { background: #1a73e8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; width: 100%; margin-top: 10px; }
        .btn-info { background: #17a2b8; color: white; }

        /* ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒªã‚¢ */
        #interactive { width: 100%; height: 200px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* çµæœãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f9fa; position: sticky; top: 0; }
        .status-loading { color: #666; font-style: italic; }
        .status-ok { color: #28a745; font-weight: bold; }
        .status-out { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ“š å›³æ›¸é¤¨è”µæ›¸ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h2>

    <div class="section">
        <div class="input-group">
            <div class="pw-container">
                <input type="password" id="api-key" placeholder="ã‚«ãƒ¼ãƒªãƒ«APIã‚­ãƒ¼">
                <button onclick="togglePassword()" style="position:absolute; right:5px; background:none; color:#999; height:100%;">ğŸ‘ï¸</button>
            </div>
            <input type="text" id="pref-id" placeholder="ã‚·ã‚¹ãƒ†ãƒ ID (ä¾‹: Tokyo_Nakano)">
        </div>
        <button class="btn-secondary" onclick="saveSettings()" style="width:100%">è¨­å®šã‚’ä¿å­˜</button>
    </div>

    <div class="section">
        <div class="input-group">
            <input type="text" id="manual-isbn" placeholder="ISBNã‚’æ‰‹å…¥åŠ› (978...)">
            <button class="btn-info" onclick="manualSearch()">æ¤œç´¢</button>
        </div>
    </div>

    <div id="interactive"></div>
    <button class="btn-primary" onclick="startScanner()" style="width:100%; margin-top:10px; padding:15px;">ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ»ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>

    <div class="section" style="margin-top:20px;">
        <button class="btn-success" onclick="copyToClipboard()">ğŸ“‹ çµæœã‚’ãƒªã‚¹ãƒˆå½¢å¼ã§ã‚³ãƒ”ãƒ¼</button>
        <div class="table-container">
            <table id="result-table">
                <thead>
                    <tr>
                        <th style="width:50%">æœ¬ã®å†…å®¹</th>
                        <th style="width:30%">åœ¨åº«çŠ¶æ³</th>
                        <th style="width:20%">ãƒªãƒ³ã‚¯</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
<div class="section" style="background: #f8f9fa; border: 1px dashed #ccc; font-size: 13px; color: #666; margin-top: 30px;">
    <h3 style="margin-top: 0; font-size: 15px; color: #333;">ğŸ“– ä½¿ã„æ–¹</h3>
    <ol style="padding-left: 20px; line-height: 1.6;">
        <li><strong>åˆæœŸè¨­å®š:</strong> <a href="https://calil.jp/doc/api.html" target="_blank">ã‚«ãƒ¼ãƒªãƒ«API</a>ã§å–å¾—ã—ãŸã‚­ãƒ¼ã¨ã€åˆ©ç”¨ã—ãŸã„å›³æ›¸é¤¨ã®<a href="https://calil.jp/lib" target="_blank">ã‚·ã‚¹ãƒ†ãƒ ID</a>ã‚’å…¥åŠ›ã—ã¦ã€Œä¿å­˜ã€ã—ã¾ã™ã€‚</li>
        <li><strong>ã‚¹ã‚­ãƒ£ãƒ³:</strong> ã€Œã‚«ãƒ¡ãƒ©èµ·å‹•ã€ã‚’æŠ¼ã—ã€æœ¬ã®è£ã«ã‚ã‚‹<strong>ä¸Šæ®µã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</strong>ï¼ˆ978...ï¼‰ã‚’æ å†…ã«åã‚ã¾ã™ã€‚</li>
        <li><strong>æ‰‹å…¥åŠ›:</strong> ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Šã«ãã„å ´åˆã¯ã€13æ¡ã®æ•°å­—ã‚’ç›´æ¥å…¥åŠ›ã—ã¦æ¤œç´¢ã‚‚å¯èƒ½ã§ã™ã€‚</li>
        <li><strong>ç¢ºèª:</strong> ãƒªã‚¹ãƒˆã«æœ¬ãŒè“„ç©ã•ã‚Œã€åœ¨åº«çŠ¶æ³ã¨äºˆç´„ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
        <li><strong>å…±æœ‰:</strong> ã€Œçµæœã‚’ã‚³ãƒ”ãƒ¼ã€ã‚’æŠ¼ã™ã¨ã€ãƒ¡ãƒ¢å¸³ã‚„LINEãªã©ã«ãƒªã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚</li>
    </ol>
    <p style="font-size: 11px; margin-bottom: 0;">â€»ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ãªã„å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€Œã‚«ãƒ¡ãƒ©ä½¿ç”¨è¨±å¯ã€ã¨ã€HTTPSæ¥ç¶šï¼ˆhttps://ã€œï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
</div>
<script>
    let lastIsbn = "";
    let isProcessing = false;
    let retryCounts = {};

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è¨­å®šã‚’å¾©å…ƒ
    window.onload = () => {
        document.getElementById('api-key').value = localStorage.getItem('calil_api_key') || '';
        document.getElementById('pref-id').value = localStorage.getItem('calil_system_id') || '';
    };

    function togglePassword() {
        const input = document.getElementById('api-key');
        input.type = input.type === "password" ? "text" : "password";
    }

    function saveSettings() {
        const apiKey = document.getElementById('api-key').value;
        const systemId = document.getElementById('pref-id').value;
        localStorage.setItem('calil_api_key', apiKey);
        localStorage.setItem('calil_system_id', systemId);
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•
    function startScanner() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: { facingMode: "environment" }
            },
            decoder: { 
                readers: ["ean_reader"],
                multiple: false 
            },
            locate: true
        }, function(err) {
            if (err) { alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err); return; }
            Quagga.start();
        });
    }

    Quagga.onDetected(function(data) {
        const code = data.codeResult.code;
        if (code.startsWith("978") && code.length === 13) {
            if (code !== lastIsbn && !isProcessing) {
                isProcessing = true;
                lastIsbn = code;
                addBookToList(code);
                // 5ç§’é–“ã¯åŒä¸€ISBNã‚’ãƒ­ãƒƒã‚¯ï¼ˆèª¤èª­é˜²æ­¢ï¼‰
                setTimeout(() => { lastIsbn = ""; isProcessing = false; }, 5000);
            }
        }
    });

    function manualSearch() {
        const input = document.getElementById('manual-isbn');
        let isbn = input.value.replace(/-/g, '').trim();
        if ((isbn.startsWith("978") || isbn.startsWith("979")) && isbn.length === 13) {
            addBookToList(isbn);
            input.value = "";
        } else {
            alert("æœ‰åŠ¹ãª13æ¡ã®ISBNã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
    }

    async function addBookToList(isbn) {
        const tableBody = document.querySelector("#result-table tbody");
        if (document.getElementById(`row-${isbn}`)) return; // é‡è¤‡è¡¨ç¤ºé˜²æ­¢

        const row = tableBody.insertRow(0);
        row.id = `row-${isbn}`;
        row.innerHTML = `
            <td id="title-${isbn}"><small>èª­ã¿è¾¼ã¿ä¸­...<br>${isbn}</small></td>
            <td id="status-${isbn}" class="status-loading">æ¤œç´¢ä¸­...</td>
            <td id="link-${isbn}">-</td>
        `;

        fetchBookTitle(isbn);
        fetchLibraryStatus(isbn);
    }

    // Google Books APIã§ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
    async function fetchBookTitle(isbn) {
        try {
            const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
            const data = await res.json();
            const elem = document.getElementById(`title-${isbn}`);
            if (data.items && data.items[0]) {
                const info = data.items[0].volumeInfo;
                elem.innerHTML = `<strong>${info.title}</strong><br><small>${info.authors?.join(', ') || 'è‘—è€…ä¸æ˜'}</small>`;
            } else {
                elem.innerHTML = `ä¸æ˜ãªæœ¬<br><small>${isbn}</small>`;
            }
        } catch (e) { console.error(e); }
    }

    // ã‚«ãƒ¼ãƒªãƒ«API (JSONP + ãƒãƒ¼ãƒªãƒ³ã‚° + ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿)
    function fetchLibraryStatus(isbn) {
        const apiKey = localStorage.getItem('calil_api_key');
        const systemId = localStorage.getItem('calil_system_id');
        
        if (!apiKey || !systemId) return;
        if (!retryCounts[isbn]) retryCounts[isbn] = 0;
        retryCounts[isbn]++;

        const cb = `cb_${isbn}_${Date.now()}`;
        window[cb] = function(data) {
            if (data.continue === 1 && retryCounts[isbn] < 15) {
                document.getElementById(`status-${isbn}`).innerText = `æ¤œç´¢ä¸­...(${retryCounts[isbn]})`;
                setTimeout(() => fetchLibraryStatus(isbn), 2000);
            } else {
                renderResult(isbn, data, systemId);
            }
            document.getElementById(`sc-${isbn}`)?.remove();
            delete window[cb];
        };

        const script = document.createElement('script');
        script.id = `sc-${isbn}`;
        script.src = `https://api.calil.jp/check?appkey=${apiKey}&isbn=${isbn}&systemid=${systemId}&format=json&callback=${cb}&t=${Date.now()}`;
        document.body.appendChild(script);
    }

    function renderResult(isbn, data, systemId) {
        const statusTd = document.getElementById(`status-${isbn}`);
        const linkTd = document.getElementById(`link-${isbn}`);
        const bookData = data.books?.[isbn]?.[systemId];

        if (!bookData || !bookData.libkey || Object.keys(bookData.libkey).length === 0) {
            statusTd.innerText = "è”µæ›¸ãªã—";
            statusTd.className = "";
        } else {
            const statuses = Object.values(bookData.libkey);
            if (statuses.some(s => s.includes("è²¸å‡ºå¯") || s.includes("ã‚ã‚Š") || s === "OK")) {
                statusTd.innerText = "åœ¨åº«ã‚ã‚Š";
                statusTd.className = "status-ok";
            } else {
                statusTd.innerText = "è²¸å‡ºä¸­/ä»–";
                statusTd.className = "status-out";
            }
            if (bookData.reserveurl) {
                linkTd.innerHTML = `<a href="${bookData.reserveurl}" target="_blank">äºˆç´„</a>`;
            }
        }
    }

    function copyToClipboard() {
        const rows = document.querySelectorAll("#result-table tbody tr");
        if (rows.length === 0) return;
        let text = "ã€å›³æ›¸é¤¨æ¤œç´¢ãƒªã‚¹ãƒˆã€‘\n";
        rows.forEach(row => {
            const title = row.querySelector("td[id^='title-']").innerText.split('\n')[0];
            const status = row.querySelector("td[id^='status-']").innerText;
            text += `â–  ${title}ï¼š${status}\n`;
        });
        navigator.clipboard.writeText(text).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
    }
</script>
</body>
</html>
