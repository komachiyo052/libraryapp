<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›³æ›¸é¤¨è”µæ›¸ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f4f9; }
        #interactive { width: 100%; height: 250px; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .controls { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        input, button { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; cursor: pointer; border: none; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #eee; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <h2>ğŸ“š å›³æ›¸é¤¨è”µæ›¸ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h2>

    <div class="controls">
        <input type="text" id="pref-id" placeholder="è‡ªæ²»ä½“å (ä¾‹: æ±äº¬éƒ½)" value="æ±äº¬éƒ½">
        <input type="text" id="api-key" placeholder="ã‚«ãƒ¼ãƒªãƒ«APIã‚­ãƒ¼ã‚’å…¥åŠ›">
    </div>

    <div id="interactive" class="viewport"></div>

    <div class="controls">
        <button onclick="startScanner()">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
        <button onclick="copyToClipboard()" style="background: #28a745;">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>

    <table id="result-table">
        <thead>
            <tr>
                <th>ISBN</th>
                <th>çŠ¶æ…‹</th>
                <th>ãƒªãƒ³ã‚¯</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

<script>
    let lastIsbn = "";
    let isScanning = false;

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®åˆæœŸåŒ–
    function startScanner() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: { facingMode: "environment" }
            },
            decoder: { readers: ["ean_reader"] } // ISBNã¯EAN(JAN)ã‚³ãƒ¼ãƒ‰å½¢å¼
        }, function(err) {
            if (err) { console.error(err); return; }
            Quagga.start();
            isScanning = true;
        });
    }

    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œçŸ¥æ™‚ã®å‡¦ç†
    Quagga.onDetected(function(data) {
        const code = data.codeResult.code;
        
        // 978ã‹ã‚‰å§‹ã¾ã‚‹13æ¡ã®ISBNã®ã¿å¯¾è±¡
        if (code.startsWith("978") && code.length === 13) {
            if (code !== lastIsbn) {
                lastIsbn = code;
                addBookToList(code);
                
                // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³ã®ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼ˆ3ç§’é–“ã¯åŒã˜æœ¬ã‚’èª­ã¾ãªã„ï¼‰
                setTimeout(() => { lastIsbn = ""; }, 3000);
            }
        }
    });

    // ãƒªã‚¹ãƒˆã«æœ¬ã‚’è¿½åŠ ï¼ˆã“ã“ã§APIã‚’å©ãæƒ³å®šï¼‰
    function addBookToList(isbn) {
        const tableBody = document.querySelector("#result-table tbody");
        const row = tableBody.insertRow(0); // æ–°ã—ã„ã‚‚ã®ã‚’ä¸Šã«
        
        row.innerHTML = `
            <td>${isbn}</td>
            <td id="status-${isbn}">å–å¾—ä¸­...</td>
            <td id="link-${isbn}">-</td>
        `;

        // æœ¬æ¥ã¯ã“ã“ã§ã‚«ãƒ¼ãƒªãƒ«APIã‚’å‘¼ã³å‡ºã™
        fetchLibraryStatus(isbn);
    }

// ã‚«ãƒ¼ãƒªãƒ«APIå‘¼ã³å‡ºã—ï¼ˆJSONPå¯¾å¿œç‰ˆï¼‰
function fetchLibraryStatus(isbn) {
    const apiKey = document.getElementById('api-key').value;
    const systemId = document.getElementById('pref-id').value; // ä¾‹: Tokyo_Nakano
    
    if (!apiKey) {
        document.getElementById(`status-${isbn}`).innerText = "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
    }

    // JSONPç”¨ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°åã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ç”Ÿæˆ
    const callbackName = `callback_${isbn}`;
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
    window[callbackName] = function(data) {
        renderResult(isbn, data);
        // ä½¿ã„çµ‚ã‚ã£ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã¨é–¢æ•°ã‚’å‰Šé™¤ã—ã¦æƒé™¤
        document.getElementById(`script-${isbn}`).remove();
        delete window[callbackName];
    };

    // APIã®URLã‚’æ§‹ç¯‰ï¼ˆcallbackãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ä¸Šè¨˜é–¢æ•°åã‚’æŒ‡å®šï¼‰
    const url = `https://api.calil.jp/check?appkey=${apiKey}&isbn=${isbn}&systemid=${systemId}&format=json&callback=${callbackName}`;

    // scriptã‚¿ã‚°ã‚’ç”Ÿæˆã—ã¦APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    const script = document.createElement('script');
    script.id = `script-${isbn}`;
    script.src = url;
    document.body.appendChild(script);
}

// APIã®çµæœã‚’ç”»é¢ã«åæ˜ ã™ã‚‹é–¢æ•°
function renderResult(isbn, data) {
    const statusTd = document.getElementById(`status-${isbn}`);
    const linkTd = document.getElementById(`link-${isbn}`);
    
    // ã‚«ãƒ¼ãƒªãƒ«APIã¯ã€Œç¶™ç¶šä¸­(continue)ã€ã‚’è¿”ã™ã“ã¨ãŒã‚ã‚‹ãŸã‚ç°¡æ˜“åˆ¤å®š
    if (data.continue === 1) {
        statusTd.innerText = "ç¢ºèªä¸­...(å†è©¦è¡ŒãŒå¿…è¦)";
        // æœ¬æ¥ã¯2ç§’å¾Œã«ã‚‚ã†ä¸€åº¦å©ãå‡¦ç†ã‚’å…¥ã‚Œã‚‹ã¨è¦ªåˆ‡ã§ã™
        return;
    }

    const systemData = data.libkey[Object.keys(data.libkey)[0]]; // æœ€åˆã®å›³æ›¸é¤¨ã‚·ã‚¹ãƒ†ãƒ ã®çµæœã‚’å–å¾—
    
    if (!systemData) {
        statusTd.innerText = "æ‰€è”µãªã—";
        return;
    }

    // è”µæ›¸çŠ¶æ…‹ã®åˆ¤å®š
    let statusText = "ä¸æ˜";
    if (systemData === "OK") statusText = "è”µæ›¸ã‚ã‚Š";
    else if (systemData === "Tè²¸å‡ºä¸­") statusText = "è²¸å‡ºä¸­";
    else if (systemData === "è”µæ›¸ã‚ã‚Š") statusText = "è”µæ›¸ã‚ã‚Š"; 
    // â€»APIã®æˆ»ã‚Šå€¤ã¯è‡ªæ²»ä½“ã«ã‚ˆã£ã¦ã€ŒOKã€ã‚„ã€Œè”µæ›¸ã‚ã‚Šã€ãªã©æºã‚ŒãŒã‚ã‚Šã¾ã™

    statusTd.innerText = statusText;
    linkTd.innerHTML = `<a href="https://calil.jp/book/${isbn}" target="_blank">äºˆç´„/è©³ç´°</a>`;
}

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    function copyToClipboard() {
        const rows = document.querySelectorAll("#result-table tbody tr");
        let text = "ã€å›³æ›¸é¤¨æ¤œç´¢çµæœãƒªã‚¹ãƒˆã€‘\n";
        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            text += `ISBN: ${cells[0].innerText} | çŠ¶æ…‹: ${cells[1].innerText}\n`;
        });
        navigator.clipboard.writeText(text).then(() => {
            alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        });
    }
</script>
</body>
</html>
